name: Build

on:
  push:
    branches: [main, dev]
    paths:
      - '.github/workflows/**'
      - 'src/**'
      - 'tests/**'
      - 'custom_components/**'
      - 'package.json'
      - 'package-lock.json'
      - 'rollup.config.mjs'
      - 'requirements_test.txt'
      - 'pyproject.toml'
      - '.eslintrc.json'
      - 'tsconfig.json'
      - 'tsconfig.test.json'
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/**'
      - 'src/**'
      - 'tests/**'
      - 'custom_components/**'
      - 'package.json'
      - 'package-lock.json'
      - 'rollup.config.mjs'
      - 'requirements_test.txt'
      - 'pyproject.toml'
      - '.eslintrc.json'
      - 'tsconfig.json'
      - 'tsconfig.test.json'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      # === Python Setup ===
      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v5
        with:
          python-version: '3.12.8'
          cache: 'pip'
          cache-dependency-path: 'requirements_test.txt'

      - name: Install Python dependencies
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: pip install -r requirements_test.txt

      # === Python Linting ===
      - name: Cache ruff
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v4
        with:
          path: ~/.cache/ruff
          key: ruff-${{ runner.os }}-${{ hashFiles('requirements_test.txt') }}
          restore-keys: |
            ruff-${{ runner.os }}-

      - name: Run ruff (Python linter)
        run: ruff check custom_components/ tests/ --output-format=github

      - name: Check ruff formatting
        run: ruff format --check --diff custom_components/ tests/

      - name: Cache Pyright
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v4
        with:
          path: ~/.cache/pyright
          key: pyright-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            pyright-${{ runner.os }}-

      - name: Run Pyright (Python type checker)
        run: pyright custom_components/autosnooze/

      # === Node.js Setup ===
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v4
        with:
          node-version: '20.18.1'
          cache: 'npm'

      - name: Install npm dependencies
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: npm ci

      - name: Audit npm dependencies
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 5
          command: npm audit --audit-level=high

      # === TypeScript/JavaScript Linting ===
      - name: Cache ESLint
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v4
        with:
          path: .eslintcache
          key: eslint-${{ runner.os }}-${{ hashFiles('package-lock.json', '.eslintrc.json') }}
          restore-keys: |
            eslint-${{ runner.os }}-

      - name: Run ESLint (TypeScript/JavaScript linter)
        run: npm run lint -- --cache --cache-location .eslintcache

      - name: Run TypeScript type checking
        run: npm run typecheck

      # === Validation ===
      - name: Validate version consistency
        run: |
          echo "Validating version consistency across files..."

          # Extract versions (CARD_VERSION is injected from package.json at build time)
          PACKAGE_VERSION=$(jq -r '.version' package.json)
          MANIFEST_VERSION=$(jq -r '.version' custom_components/autosnooze/manifest.json)

          echo "package.json version:  $PACKAGE_VERSION"
          echo "manifest.json version: $MANIFEST_VERSION"
          echo "(CARD_VERSION is injected from package.json at build time)"

          # Validate versions match
          if [ "$PACKAGE_VERSION" != "$MANIFEST_VERSION" ]; then
            echo ""
            echo "ERROR: Version mismatch detected!"
            echo "  package.json:  $PACKAGE_VERSION"
            echo "  manifest.json: $MANIFEST_VERSION"
            echo ""
            echo "Please ensure both files have the same version number."
            exit 1
          fi

          # Validate semantic versioning format (major.minor.patch)
          if ! echo "$PACKAGE_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Version '$PACKAGE_VERSION' does not follow semantic versioning format!"
            echo "Expected format: MAJOR.MINOR.PATCH (e.g., 1.0.0, 2.9.11)"
            exit 1
          fi

          echo ""
          echo "Version validation passed: $PACKAGE_VERSION"

      # === Testing ===
      - name: Run TypeScript/JavaScript tests with coverage
        run: npm run test:coverage
        timeout-minutes: 5
        env:
          CI: 'true'
        # Vitest coverage thresholds are enforced via vitest.config.mjs (85% minimum)

      - name: Run Python tests with coverage
        run: pytest tests/ -v --cov=custom_components/autosnooze --cov-report=term-missing --cov-report=xml
        env:
          TZ: UTC
        # Python coverage threshold enforced via pyproject.toml (85% minimum)

      # === Build ===
      - name: Build card
        run: npm run build

      - name: Verify no bare imports in built file
        run: |
          if grep -E "from ['\"]lit['\"]" custom_components/autosnooze/www/autosnooze-card.js; then
            echo "ERROR: Built file contains bare 'lit' import - bundling failed!"
            exit 1
          fi
          echo "Build verified: no bare imports found"

      # === Artifacts ===
      - name: Upload built artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: autosnooze-card
          path: custom_components/autosnooze/www/autosnooze-card.js
          retention-days: 7

      - name: Upload Python coverage report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: python-coverage
          path: coverage.xml
          retention-days: 7

      - name: Upload JavaScript coverage report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: js-coverage
          path: coverage/
          retention-days: 7
