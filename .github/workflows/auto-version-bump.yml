name: Auto Version Bump

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'custom_components/**'
      - '!custom_components/autosnooze/manifest.json'

jobs:
  bump-version:
    runs-on: ubuntu-latest
    # Skip if commit message indicates version bump or is from bot
    if: "!contains(github.event.head_commit.message, '[skip-version-bump]') && !contains(github.event.head_commit.message, 'Auto bump version') && !contains(github.event.head_commit.message, 'Bump version to')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump patch version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(jq -r '.version' package.json)
          echo "Current version: $CURRENT_VERSION"

          # Parse version components
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

          # Bump patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "New version: $NEW_VERSION"

          # Update package.json
          jq ".version = \"$NEW_VERSION\"" package.json > package.json.tmp && mv package.json.tmp package.json

          # Update manifest.json
          jq ".version = \"$NEW_VERSION\"" custom_components/autosnooze/manifest.json > manifest.json.tmp && mv manifest.json.tmp custom_components/autosnooze/manifest.json

          # Update CARD_VERSION in source file
          sed -i "s/const CARD_VERSION = \"[^\"]*\"/const CARD_VERSION = \"$NEW_VERSION\"/" src/autosnooze-card.js

          # Update version comment in source file
          sed -i "s/\/\/ Version [0-9]*\.[0-9]*\.[0-9]*/\/\/ Version $NEW_VERSION/" src/autosnooze-card.js

          # Verify all versions match
          echo "Verifying version update..."
          PACKAGE_VERSION=$(jq -r '.version' package.json)
          MANIFEST_VERSION=$(jq -r '.version' custom_components/autosnooze/manifest.json)
          CARD_VERSION=$(grep -oP 'const CARD_VERSION = "\K[^"]+' src/autosnooze-card.js)

          echo "  package.json:  $PACKAGE_VERSION"
          echo "  manifest.json: $MANIFEST_VERSION"
          echo "  CARD_VERSION:  $CARD_VERSION"

          if [ "$PACKAGE_VERSION" != "$NEW_VERSION" ] || [ "$MANIFEST_VERSION" != "$NEW_VERSION" ] || [ "$CARD_VERSION" != "$NEW_VERSION" ]; then
            echo "ERROR: Version update failed!"
            exit 1
          fi

          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Bump version to ${{ env.NEW_VERSION }}"
          title: "Bump version to ${{ env.NEW_VERSION }}"
          body: |
            Automated version bump from ${{ github.sha }}.

            Updates version to `${{ env.NEW_VERSION }}` in:
            - package.json
            - manifest.json
            - src/autosnooze-card.js
          branch: auto-version-bump-${{ env.NEW_VERSION }}
          delete-branch: true
          labels: automated
