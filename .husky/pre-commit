# Auto-fix branch naming convention
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" == claude/* ]]; then
  NEW_BRANCH="${BRANCH#claude/}"
  echo "Renaming branch: $BRANCH -> $NEW_BRANCH"
  git branch -m "$NEW_BRANCH"
fi

# Run lint-staged for formatting and linting
npx lint-staged

# Build the card if source files changed
if git diff --cached --name-only | grep -q "^src/"; then
  echo "Building card (src/ changed)..."
  npm run build
  git add custom_components/autosnooze/www/autosnooze-card.js
fi

# Run quick tests (fail fast, no coverage for speed)
echo "Running JavaScript tests..."
npm test -- --bail=1 --changed=HEAD~1

echo "Running Python tests..."
python -m pytest tests/ -x -q --tb=short || echo "Python tests skipped (pytest not available)"
